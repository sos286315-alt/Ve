<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>全国 青果物 価格相場</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f7f9fb;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #2d7a46;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  main {
    max-width: 900px;
    margin: 2rem auto;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  select {
    padding: 0.5rem;
    width: 100%;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 0.5rem;
  }
  canvas {
    margin-top: 2rem;
    width: 100%;
    height: 400px;
  }
</style>
</head>
<body>
  <header>
    <h1>全国 青果物 価格相場</h1>
    <p>地域別・品目別に価格の変動を可視化</p>
  </header>

  <main>
    <label for="region">地域を選択：</label>
    <select id="region"></select>

    <label for="item">品目を選択：</label>
    <select id="item"></select>

    <canvas id="priceChart"></canvas>
  </main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRm5gh052oiL5nMi17I6ao4UMdcI_sT53FFQjBbMW5MayE8VFzVU0qEfwxHZOmsrFKiUyBcLgGGZxAU/pub?gid=0&single=true&output=csv";

let chart;
let allData = [];

async function loadData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.trim().split("\n").map(r => r.split(","));
  const headers = rows.shift();
  allData = rows.map(r => ({
    date: r[0],
    region: r[1],
    item: r[2],
    unit: r[3],
    price: parseFloat(r[4])
  }));
  populateSelectors();
}

function populateSelectors() {
  const regions = [...new Set(allData.map(d => d.region))].sort();
  const items = [...new Set(allData.map(d => d.item))].sort();

  const regionSelect = document.getElementById("region");
  const itemSelect = document.getElementById("item");

  regionSelect.innerHTML = regions.map(r => `<option>${r}</option>`).join("");
  itemSelect.innerHTML = items.map(i => `<option>${i}</option>`).join("");

  regionSelect.addEventListener("change", updateChart);
  itemSelect.addEventListener("change", updateChart);

  updateChart();
}

function updateChart() {
  const region = document.getElementById("region").value;
  const item = document.getElementById("item").value;
  const filtered = allData.filter(d => d.region === region && d.item === item);

  const labels = filtered.map(d => d.date);
  const prices = filtered.map(d => d.price);

  const ctx = document.getElementById("priceChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: `${region} - ${item} の価格推移`,
        data: prices,
        borderColor: "#2d7a46",
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      scales: {
        y: { title: { display: true, text: "価格（円）" } },
        x: { title: { display: true, text: "日付" } }
      }
    }
  });
}

loadData();
</script>
</body>
</html>
